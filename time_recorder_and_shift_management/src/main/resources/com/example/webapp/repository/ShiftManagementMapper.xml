<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.example.webapp.repository.ShiftManagementMapper">

	<resultMap id="EntityForFullCalendarResult"
		type="com.example.webapp.entity.EntityForFullCalendar">
		<id property="id" column="id"/>
		<result property="employeeId" column="employee_id"/>
		<result property="title" column="name" />
		<result property="start" column="date" />
	</resultMap>

	<select id="selectThreeMonthShiftsByTargetMonth"
		resultMap="EntityForFullCalendarResult">
<!--		SELECT x.id,name,DATE_FORMAT(date,'%Y-%m-%d') as date-->
		SELECT
		  s.id
		  ,e.name
		  ,s.date
		FROM
		  test_shifts_and_timestamps AS s
		    INNER JOIN test_employees_list AS e
		      ON s.employee_id = e.id
		WHERE
		  MONTH(date) BETWEEN #{targetMonth} -1 AND #{targetMonth} +1
		;
	</select>

	<select id="selectRequestsByEmployeeId"
		resultMap="EntityForFullCalendarResult">
		SELECT
		  id
		  ,date
		FROM
		  requests
		WHERE
		  employee_id = #{employeeId}
		;
	</select>

	<select id="selectOneMonthShiftsByTargetMonth"
		resultMap="EntityForFullCalendarResult">
		SELECT
		  s.id
		  ,e.name
		  ,s.date
<!--		  ,DATE_FORMAT(date,'%Y-%m-%d') as date-->
		FROM
		  test_shifts_and_timestamps AS s
		    INNER JOIN test_employees_list AS e
		      ON s.employee_id = e.id
		WHERE
		  MONTH(date) = #{targetMonth}
		;
	</select>

	<select id="selectAllRequests"
		resultMap="EntityForFullCalendarResult">
		SELECT
		  r.id
		  ,r.employee_id
		  ,e.name
		  ,r.date
<!--		  ,DATE_FORMAT(date,'%Y-%m-%d') as date-->
		FROM
		  requests AS r
		    INNER JOIN test_employees_list AS e
		      ON r.employee_id = e.id
		;
	</select>

	<!-- 英語的にはEmployeesHaveNotSubmittedYetが正しいと思う -->
	<select id="selectEmployeesNotSubmitRequests">
		SELECT
		  id
		  ,name
		FROM
		  employees_list
		WHERE
		  id NOT IN (
		    SELECT
		      employee_id
		    FROM
		      requests
		  )
		;
	</select>

	<insert id="insertShiftRequests">
		INSERT INTO
		  requests(employee_id, date)
		VALUES 
		<foreach collection="newShifts" item="r" separator=",">
			(#{r.employeeId}, #{r.start})
		</foreach>
		;
	</insert>

	<insert id="insertNextMonthShifts">
		INSERT INTO
		  test_shifts_and_timestamps(employee_id,date,created_at,updated_at)
		VALUES
		<foreach collection="newShifts" item="s" separator=",">
			(#{s.employeeId},#{s.start},now(),now())
		</foreach>
		;
	</insert>

	<delete id="deleteRequestsByEmployeeId">
		DELETE FROM
		  requests
		WHERE
		  employee_id = #{employeeId}
		;
	</delete>

	<delete id="deleteShiftsByTargetMonth">
		DELETE FROM
		  test_shifts_and_timestamps
		WHERE
		  MONTH(date) = #{targetMonth}
		;
	</delete>


	<!-- 以下はサックル提出分には含めない -->
	<!-- <update id="createShiftRequestsTable"> -->
	<!-- CREATE TABLE test_shift_requests_${newMonth} -->
	<!-- (id INT AUTO_INCREMENT PRIMARY KEY, -->
	<!-- employee_id INT NOT NULL, -->
	<!-- date date NOT NULL, -->
	<!-- FOREIGN KEY (employee_id) -->
	<!-- REFERENCES test_employees_list(id) -->
	<!-- ) -->
	<!-- </update> -->

	<!-- <update id="dropForeignKeyOfShiftRequestsTable"> -->
	<!-- ALTER TABLE test_shift_requests_${oldMonth} DROP FOREIGN KEY -->
	<!-- test_shift_requests_${oldMonth}_ibfk_1 -->
	<!-- </update> -->

	<!-- <delete id="deleteShiftRequestTable"> -->
	<!-- DROP TABLE test_shift_requests_${oldMonth}; -->
	<!-- </delete> -->


</mapper>